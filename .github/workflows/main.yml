name: Start Localtonet SSH Tunnel

on:
  workflow_dispatch:

jobs:
  tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Update and install packages
      run: |
        sudo apt-get update
        sudo apt-get install -y wget openssh-server

    - name: Generate SSH key
      run: |
        ssh-keygen -t rsa -b 2048 -f ./ws -N ""
        cat ./ws.pub >> ~/.ssh/authorized_keys
        chmod 600 ./ws
        chmod 700 ~/.ssh
        chmod 600 ~/.ssh/authorized_keys

    - name: Download and unzip localtonet
      run: |
        wget https://localtonet.com/download/localtonet-linux-x64.zip
        unzip localtonet-linux-x64.zip

    - name: Start SSH service
      run: |
        sudo service ssh start

    - name: Start localtonet tunnel
      run: |
        ./localtonet tunnel 22 > tunnel.log 2>&1 &
        sleep 5
        grep -i "localto.net" tunnel.log || cat tunnel.log

    - name: Show private key
      run: |
        echo "::set-output name=key::$(cat ./ws)"
      id: getkey

    - name: Print SSH Command
      run: |
        echo "Aşağıdaki anahtarı kullanarak bağlanabilirsin:"
        echo ""
        echo "${{ steps.getkey.outputs.key }}"
        echo ""
        echo "Örnek bağlanma komutu (port ve host log'dan alınır):"
        echo "ssh -i ws root@host.localto.net -p PORT"
