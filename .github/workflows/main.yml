name: Kur Otomatik SSH + LocalToNet

on:
  workflow_dispatch:

jobs:
  ssh-ve-tunel:
    runs-on: ubuntu-latest
    steps:
    - name: SSH anahtarı oluştur
      run: |
        mkdir -p ~/.ssh
        ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -q -N ""
        echo "🗝️ Public key:"
        cat ~/.ssh/id_rsa.pub

    - name: localtonet indir
      run: |
        wget -q https://localtonet.com/download/localtonet-linux-x64.zip -O lt.zip
        unzip -o lt.zip
        chmod +x localtonet
        echo "✅ Localtonet indirildi"

    - name: localtonet başlat (arka planda)
      run: |
        nohup ./localtonet tcp --port 22 > lt.log 2>&1 &
        echo "⏳ Tünel kuruluyor..."
        sleep 20

    - name: bağlantı linkini al
      id: link_al
      run: |
        echo "🔍 Tünel log kontrol ediliyor..."
        if grep -oE "tcp://[a-zA-Z0-9\.\-]+:\d+" lt.log > lt_link.txt; then
          link=$(cat lt_link.txt | head -n1)
          echo "✅ Bağlantı kuruldu: $link"
          echo "ssh_link=$link" >> $GITHUB_OUTPUT
        else
          echo "❌ Localtonet bağlantı linki bulunamadı!"
          cat lt.log
          exit 1
        fi

    - name: SSH bağlantı komutu ve indirme linki
      run: |
        whoami
        echo "🔗 SSH bağlantı komutu:"
        echo ""
        echo "ssh -o StrictHostKeyChecking=no -i id_rsa root@${{ steps.link_al.outputs.ssh_link#tcp:// }}"
        echo ""
        echo "🔽 SSH private key (indirme linki):"
        curl -F 'file=@/home/runner/.ssh/id_rsa' https://file.io | tee ssh_key_link.txt
