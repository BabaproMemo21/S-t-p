name: LocalToNet SSH Tüneli

on:
  workflow_dispatch:

jobs:
  tünel:
    runs-on: ubuntu-latest
    steps:
      - name: LocalToNet indir
        run: |
          wget https://localtonet.com/download/localtonet-linux-x64.zip
          unzip localtonet-linux-x64.zip
          chmod +x localtonet

      - name: SSH Anahtarı oluştur
        run: |
          ssh-keygen -t ed25519 -f key -N ""
          echo "Aşağıdaki public key'i sunucuna authorized_keys'e ekle:"
          cat key.pub

      - name: LocalToNet ile tünel başlat
        id: baglan
        run: |
          nohup ./localtonet tcp 22 --authtoken "${{ secrets.LOCALTONET_TOKEN }}" > log.txt 2>&1 &
          echo "Tünel açılıyor, bağlantı bekleniyor..."
          sleep 10
          for i in {1..20}; do
            echo "🔁 $i. deneme: Bağlantı kontrol ediliyor..."
            LINK=$(grep -oE "tcp://[a-zA-Z0-9\.-]+:[0-9]+" log.txt || true)
            if [[ ! -z "$LINK" ]]; then
              echo "🔗 Bağlantı kuruldu: $LINK"
              echo "ssh_link=$LINK" >> $GITHUB_OUTPUT
              break
            fi
            sleep 3
          done

      - name: Bağlantı bilgisini göster
        if: steps.baglan.outputs.ssh_link != ''
        run: |
          echo "👤 Kullanıcı adı: $(whoami)"
          echo "📥 SSH Key indir: https://raw.githubusercontent.com/${{ github.repository }}/main/key"
          echo "📡 SSH Bağlantı komutu:"
          echo "ssh -i key $(whoami)@${{ steps.baglan.outputs.ssh_link#tcp:// }}"

      - name: Bağlantı başarısız
        if: steps.baglan.outputs.ssh_link == ''
        run: |
          echo "‼️ LocalToNet bağlantısı başarısız oldu! log.txt içeriği:"
          cat log.txt
          exit 1
