name: Localtonet SSH Tunnel + SSH Setup + Zip Artifact

on:
  workflow_dispatch:

jobs:
  setup-and-tunnel:
    runs-on: ubuntu-latest

    steps:
      - name: Localtonet indir ve aç
        run: |
          wget https://localtonet.com/download/localtonet-linux-x64.zip
          unzip -o localtonet-linux-x64.zip
          chmod +x localtonet

      - name: SSH anahtarı oluştur ve authorized_keys'e ekle
        run: |
          ssh-keygen -t rsa -b 4096 -N "" -f ./id_rsa
          mkdir -p ~/.ssh
          cat ./id_rsa.pub >> ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys

      - name: root şifresini 313131 olarak ayarla
        run: |
          echo -e "313131\n313131" | sudo passwd root

      - name: Localtonet tünel başlat ve 30 saniye boyunca token yapıştır
        run: |
          (
            while true; do
              echo "echZs8VqGwWdB2SFCL65li7AN3b9Ttoj4"
              sleep 2
            done
          ) | nohup ./localtonet token > tunnel.log 2>&1 &
          sleep 30

      - name: SSH bağlantı komutu oluştur
        run: |
          echo "ssh -i id_rsa -o StrictHostKeyChecking=no -p <PORT> root@<HOST>" > ssh_connect_command.txt

      - name: Dosyaları ziple
        run: |
          zip ssh_info.zip id_rsa id_rsa.pub ssh_connect_command.txt tunnel.log

      - name: Zip dosyasını artifact olarak yükle
        uses: actions/upload-artifact@v4
        with:
          name: ssh_info_zip
          path: ssh_info.zip
