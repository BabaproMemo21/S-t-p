name: Run SSH Tunnel

on:
  workflow_dispatch:

jobs:
  ssh:
    runs-on: ubuntu-latest

    steps:
      - name: LocalToNet indir
        run: |
          wget https://localtonet.com/download/localtonet-linux-x64.zip
          unzip localtonet-linux-x64.zip
          chmod +x localtonet

      - name: SSH Key oluştur
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -f ~/.ssh/id_rsa -q -N ""
          echo "🗝️ SSH Public Key:"
          cat ~/.ssh/id_rsa.pub
          echo ""
          echo "🧑 Kullanıcı adı:"
          whoami

      - name: SSH server başlat
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo service ssh start

      - name: Localtonet başlat ve linki al
        id: baglanti
        run: |
          ./localtonet --port 22 > log.txt 2>&1 &
          echo "🕐 Tünel başlatılıyor..."
          sleep 20
          echo "📄 LOG DOSYASI:"
          cat log.txt
          LINK=$(grep -oE 'tcp://[a-zA-Z0-9./:-]+' log.txt | head -n 1)
          echo "📡 Bağlantı linki: $LINK"
          echo "ssh_link=$LINK" >> $GITHUB_OUTPUT

      - name: SSH komutu ve indirme bağlantısı
        run: |
          echo "🔗 SSH bağlantı linki: ${{ steps.baglanti.outputs.ssh_link }}"
          echo "📥 indirme bağlantısı:"
          echo "${{ steps.baglanti.outputs.ssh_link }}" > link.txt
