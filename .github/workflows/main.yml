name: LocalToNet SSH TÃ¼neli

on:
  workflow_dispatch:

jobs:
  tÃ¼nel:
    runs-on: ubuntu-latest
    steps:
      - name: LocalToNet indir
        run: |
          wget https://localtonet.com/download/localtonet-linux-x64.zip
          unzip localtonet-linux-x64.zip
          chmod +x localtonet

      - name: SSH AnahtarÄ± oluÅŸtur
        run: |
          ssh-keygen -t ed25519 -f key -N ""
          echo "AÅŸaÄŸÄ±daki public key'i sunucuna authorized_keys'e ekle:"
          cat key.pub

      - name: LocalToNet ile tÃ¼nel baÅŸlat
        id: baglan
        run: |
          nohup ./localtonet tcp 22 --authtoken "${{ secrets.LOCALTONET_TOKEN }}" > log.txt 2>&1 &
          echo "TÃ¼nel aÃ§Ä±lÄ±yor, baÄŸlantÄ± bekleniyor..."
          sleep 10
          for i in {1..20}; do
            echo "ğŸ” $i. deneme: BaÄŸlantÄ± kontrol ediliyor..."
            LINK=$(grep -oE "tcp://[a-zA-Z0-9\.-]+:[0-9]+" log.txt || true)
            if [[ ! -z "$LINK" ]]; then
              echo "ğŸ”— BaÄŸlantÄ± kuruldu: $LINK"
              echo "ssh_link=$LINK" >> $GITHUB_OUTPUT
              break
            fi
            sleep 3
          done

      - name: BaÄŸlantÄ± bilgisini gÃ¶ster
        if: steps.baglan.outputs.ssh_link != ''
        run: |
          echo "ğŸ‘¤ KullanÄ±cÄ± adÄ±: $(whoami)"
          echo "ğŸ“¥ SSH Key indir: https://raw.githubusercontent.com/${{ github.repository }}/main/key"
          echo "ğŸ“¡ SSH BaÄŸlantÄ± komutu:"
          echo "ssh -i key $(whoami)@${{ steps.baglan.outputs.ssh_link#tcp:// }}"

      - name: BaÄŸlantÄ± baÅŸarÄ±sÄ±z
        if: steps.baglan.outputs.ssh_link == ''
        run: |
          echo "â€¼ï¸ LocalToNet baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z oldu! log.txt iÃ§eriÄŸi:"
          cat log.txt
          exit 1
