name: Localtonet SSH Tunnel + SSH Setup + Zip Artifact

on:
  workflow_dispatch:

jobs:
  setup-and-tunnel:
    runs-on: ubuntu-latest

    env:
      AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}

    steps:
      - name: Localtonet indir ve aç
        run: |
          wget https://localtonet.com/download/localtonet-linux-x64.zip
          unzip -o localtonet-linux-x64.zip
          chmod +x localtonet

      - name: SSH anahtarı oluştur ve authorized_keys'e ekle
        run: |
          ssh-keygen -t rsa -b 4096 -N "" -f ./id_rsa
          mkdir -p ~/.ssh
          cat ./id_rsa.pub >> ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys

      - name: root şifresini 313131 olarak ayarla
        run: |
          echo -e "313131\n313131" | sudo passwd root

      - name: Localtonet tünel başlat ve çıktıyı kaydet
        run: |
          nohup ./localtonet token "${AUTH_TOKEN}" > tunnel.log 2>&1 &
          sleep 30
          cat tunnel.log

      - name: Bağlantı linkini çıkar ve dosyaya yaz
        id: get_link
        run: |
          LINK=$(grep -oE '[a-z0-9]+\.localto\.net:[0-9]+' tunnel.log | head -n1)
          if [ -z "$LINK" ]; then
            echo "‼️ Localtonet bağlantı linki bulunamadı!"
            exit 1
          fi
          echo $LINK > ssh_link.txt
          echo "::set-output name=link::$LINK"

      - name: SSH bağlantı komutu oluştur
        run: |
          LINK=$(cat ssh_link.txt)
          HOST=$(echo "$LINK" | cut -d':' -f1)
          PORT=$(echo "$LINK" | cut -d':' -f2)
          echo "ssh -i id_rsa -o StrictHostKeyChecking=no -p $PORT root@$HOST" > ssh_connect_command.txt
          echo "Sunucuya bağlanmak için komut: ssh -i id_rsa -o StrictHostKeyChecking=no -p $PORT root@$HOST"

      - name: Dosyaları ziple
        run: |
          zip ssh_info.zip id_rsa id_rsa.pub ssh_link.txt ssh_connect_command.txt tunnel.log

      - name: Zip dosyasını artifact olarak yükle
        uses: actions/upload-artifact@v4
        with:
          name: ssh_info_zip
          path: ssh_info.zip
