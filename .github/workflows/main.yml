name: SSH Tunnel with Localtonet

on:
  workflow_dispatch:

jobs:
  ssh-setup:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Gereksinimleri yükle
        run: |
          sudo apt update
          sudo apt install -y openssh-server wget unzip

      - name: 🔑 SSH anahtarı oluştur ve yetkilendir
        run: |
          KEYFILE="/root/.ssh/id_ed25519"
          sudo mkdir -p /root/.ssh
          sudo chmod 700 /root/.ssh
          sudo ssh-keygen -t ed25519 -f "$KEYFILE" -N ""
          sudo cat "${KEYFILE}.pub" | sudo tee -a /root/.ssh/authorized_keys
          sudo chmod 600 /root/.ssh/authorized_keys
          sudo chmod 600 "${KEYFILE}"
          sudo chmod 644 "${KEYFILE}.pub"

      - name: 🚀 SSH servisini başlat
        run: sudo service ssh start

      - name: 📤 SSH anahtarını ve IP’yi göster
        run: |
          echo -e "\n🔑 SSH Private Key:"
          sudo cat /root/.ssh/id_ed25519
          echo -e "\n📌 IP Adresiniz:"
          curl -s ifconfig.me
          echo -e "\n🟢 SSH servisi çalışıyor. 22. port açık olmalı."

      - name: 📥 Localtonet indir ve kur
        run: |
          cd /opt
          sudo wget https://localtonet.com/download/localtonet-linux-x64.zip -O localtonet.zip
          sudo unzip -o localtonet.zip
          sudo chmod +x localtonet

      - name: 🔐 Localtonet başlat
        env:
          TOKEN: ${{ secrets.LOCALTOKEN }}
        run: |
          echo -e "\n🚀 Localtonet başlatılıyor..."
          sudo /opt/localtonet tunnel --token $TOKEN
