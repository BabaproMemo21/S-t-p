name: Localtonet Tunnel

on:
  workflow_dispatch:

jobs:
  create-tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Tunnel başlatılıyor...
      shell: bash
      run: |
        echo "Tünel başlatılıyor..."

        # Token buraya gelsin (gizli tut!)
        TOKEN="Senin-Localtonet-Token"

        # Localtonet indir
        wget -q https://localtonet.com/download/localtonet-linux-x64.zip
        unzip -q localtonet-linux-x64.zip
        chmod +x localtonet

        # Arka planda başlatıp loga yaz
        ./localtonet tunnel 22 --authtoken $TOKEN > tnl.log 2>&1 &

        echo "Tünel logu izleniyor..."
        
        # Bağlantı oluşana kadar en fazla 20 saniye bekle
        for i in {1..20}; do
          sleep 1
          LINK=$(grep -oE 'https://[a-zA-Z0-9.-]+.loca.lt' tnl.log || true)
          if [[ ! -z "$LINK" ]]; then
            echo "✅ Tünel bağlantısı bulundu!"
            echo "Bağlantı: $LINK"
            echo
            echo "🔐 SSH komutu:"
            echo 'ssh -o StrictHostKeyChecking=no -p 22 USER@'"$LINK"
            echo
            echo "🧑 Kullanıcı:"
            whoami
            exit 0
          fi
        done

        echo "‼️ Localtonet bağlantı linki bulunamadı!"
        echo "::error::Tünel başarısız oldu."
        exit 1
